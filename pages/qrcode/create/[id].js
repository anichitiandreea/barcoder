import Head from 'next/head'
import styles from '../../../styles/Home.module.css'
import Image from 'next/image'
import { useState } from 'react'
import Layout from '../../../components/layout'

function QrCodeCreate({data, params}) {
  const [processedData, setData] = useState('')
  const [image, setImage] = useState(data.fileContents)

  const generateCode = async() => {
    const res = await fetch('http://localhost:5000/PayloadQRCode/' + params.id + '?data=' + processedData)
    const data = await res.json()

    setImage(data.fileContents)

    return {
      props: {
        data,
        params
      },
    }
  }

  const downloadFile = async () => {
    let binaryString = window.atob(image);
    let length = binaryString.length;
    let bytes = new Uint8Array(length);

    for (var i = 0; i < length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }

    const url = window.URL.createObjectURL(
      new Blob([bytes.buffer, {type: 'image/png'}]),
    );

    const link = document.createElement('a');
    link.href = url;
    link.setAttribute(
      'download',
      `image.png`,
    );

    // Start download
    link.click();
  };

  return (
    <Layout>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={styles.main}>
        <div className={styles.container}>
          <div className={styles.generation}>
            <div className={styles.header1}>Generate QR Code</div>
            <div className={styles.description}>Complete phone number here</div>
            <div>
              <input id="phone-number" className={styles.input} type="text" value={processedData} onChange={(e) => setData(e.target.value)}/>
            </div>
            <a className={styles.button} onClick={generateCode}>
              <span className={styles.buttonText}>Generate</span>
            </a>
          </div>
          <div>
            <Image src={"data:image/png;base64," + image} alt="image" width='310px' height="310px"></Image>
            <a className={styles.longButton} onClick={downloadFile}>
              <span className={styles.buttonText} >Download</span>
            </a>
          </div>
        </div>
      </main>
    </Layout>
  )
}

// This function gets called at build time
export async function getStaticProps({params}) {
  const res = await fetch('http://localhost:5000/PayloadQRCode/' + params.id + '?data=""')
  const data = await res.json()

  return {
    props: {
      data,
      params
    },
  }
}

export async function getStaticPaths() {
  const paths = [
    { params: { id: 'sms' } },
    { params: { id: 'website' } },
    { params: { id: 'number' } }
  ]

  return {
    paths,
    fallback: true
  }
}

export default QrCodeCreate
